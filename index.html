<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Truss Drawer (Grid + Snap)</title>
<style>
  body { font-family:sans-serif; text-align:center; background:#fafafa; margin:0; }
  #toolbar { margin:10px; }
  #canvas-wrapper { display:flex; justify-content:center; }
  svg { background:white; border:1px solid #ccc; cursor:crosshair; }
  button { margin:0 5px; padding:6px 12px; }
</style>
</head>
<body>
  <h2>Interactive Truss Drawer (Grid Snap)</h2>
  <div id="toolbar">
    <button id="add-node">Add Node</button>
    <button id="add-member">Add Member</button>
    <button id="clear">Clear</button>
  </div>
  <div id="canvas-wrapper">
    <svg id="canvas" width="800" height="500"></svg>
  </div>

<script>
const canvas = document.getElementById("canvas");
const GRID = 20; // pixels per grid step

let nodes = [];
let members = [];
let mode = null;
let selectedNode = null;

// --- draw grid ---
function drawGrid() {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  for (let x = 0; x <= w; x += GRID) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", x); line.setAttribute("y1", 0);
    line.setAttribute("x2", x); line.setAttribute("y2", h);
    line.setAttribute("stroke", "#eee");
    canvas.appendChild(line);
  }
  for (let y = 0; y <= h; y += GRID) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", 0); line.setAttribute("y1", y);
    line.setAttribute("x2", w); line.setAttribute("y2", y);
    line.setAttribute("stroke", "#eee");
    canvas.appendChild(line);
  }
}

// --- redraw members and nodes ---
function redraw() {
  // remove all except grid
  while (canvas.lastChild && canvas.childNodes.length > gridCount)
    canvas.removeChild(canvas.lastChild);
  // members
  for (const m of members) {
    const n1 = nodes[m.n1], n2 = nodes[m.n2];
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", n1.x); line.setAttribute("y1", n1.y);
    line.setAttribute("x2", n2.x); line.setAttribute("y2", n2.y);
    line.setAttribute("stroke", "#000"); line.setAttribute("stroke-width", "2");
    canvas.appendChild(line);
  }
  // nodes
  for (const n of nodes) {
    const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    c.setAttribute("cx", n.x); c.setAttribute("cy", n.y);
    c.setAttribute("r", 5);
    c.setAttribute("fill", selectedNode && selectedNode.id===n.id ? "#00f" : "#d00");
    canvas.appendChild(c);
  }
}

// --- snap function ---
function snap(v) { return Math.round(v / GRID) * GRID; }

// --- click handler ---
canvas.addEventListener("click", evt => {
  const x = snap(evt.offsetX), y = snap(evt.offsetY);
  if (mode === "add-node") {
    if (!nodes.some(n => n.x===x && n.y===y)) {
      nodes.push({ id:nodes.length, x, y });
    }
  } else if (mode === "add-member") {
    // find nearest existing node
    const hit = nodes.find(n => Math.abs(n.x - x) < 8 && Math.abs(n.y - y) < 8);
    if (hit) {
      if (!selectedNode) selectedNode = hit;
      else {
        if (selectedNode.id !== hit.id) {
          members.push({ n1:selectedNode.id, n2:hit.id });
        }
        selectedNode = null;
      }
    }
  }
  redraw();
});

// --- toolbar actions ---
document.getElementById("add-node").onclick = () => { mode="add-node"; selectedNode=null; };
document.getElementById("add-member").onclick = () => { mode="add-member"; selectedNode=null; };
document.getElementById("clear").onclick = () => { nodes=[]; members=[]; selectedNode=null; redraw(); };

// init grid
drawGrid();
const gridCount = canvas.childNodes.length; // remember grid line count
</script>
</body>
</html>
